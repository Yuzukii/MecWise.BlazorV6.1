import{D as t}from"./dom-a06f5987.js";import{e,f as i,G as s,i as n,R as r,s as o,u as a,H as l}from"./dom-utils-d8c2ed7a.js";import{d as h}from"./disposable-35c3c450.js";import{S as u}from"./observables-589a5615.js";import{initFocusHidingEvents as d}from"./focus-utils-1ab9273a.js";import"./touch-2ca1b361.js";const c=window.console;class m{constructor(t){this.items=[],this.isLocked=!1,this.subscriptions=[],t&&this.addRange(t)}subscribe(t){this.isLocked||t(this.getChanges(this.items,[])),this.subscriptions.push(t)}getChanges(t,e){return{addedItems:t||[],removedItems:e||[]}}forEach(t,e){this.items.forEach(t,e)}selectMany(t,e){return this.map(t,e).reduce((function(t,e){return t.concat(e)}),[])}reduce(t,e){return this.items.reduce(t,e)}map(t,e){return this.items.map(t,e)}filter(t,e){return this.items.filter(t,e)}any(){return this.count()>0}count(){return this.items.length}get(t){return this.items[t]}add(t){this.addItemCore(t)&&this.raiseChanges([t],[])}remove(t){this.removeItemCore(t)&&this.raiseChanges([],[t])}addRange(t){this.raiseChanges(t.map(this.addItemCore.bind(this)).filter((function(t){return!!t})),[])}removeRange(t){this.raiseChanges([],t.map(this.removeItemCore.bind(this)).filter((function(t){return!!t})))}addItemCore(t){return this.items.indexOf(t)>-1?null:this.items[this.items.length]=t}removeItemCore(t){const e=this.items.indexOf(t);return-1===e?null:this.items.splice(e,1)[0]}raiseChanges(t,e){const i=this.getChanges(t,e);(i.addedItems.length>0||i.removedItems.length>0)&&this.subscriptions.forEach((function(t){t(i)}))}lock(){this.isLocked=!0}unlock(){this.isLocked=!1}}class p{constructor(t,e,i){this.layer=t,this.block=e,this.width=0,i.subscribe(e,((t,i)=>{var s;null===t&&(t=null===(s=this.layer.getPrevLayer())||void 0===s?void 0:s.getActualBlocks().filter((function(t){return t.block===e}))[0].width),t!==this.width&&(this.width=null!=t?t:0,i||this.layer.requestUpdateLayoutModel())}))}getMinWidth(){return this.width}getMaxWidth(t){return this.getMinWidth()}}class g extends p{getPrevLayerMinWidth(){const t=this.layer.getPrevLayer();return t?t.getActualBlocks().filter((t=>t.block===this.block))[0].getMinWidth():0}getMaxWidth(t){return t===this.layer?this.getPrevLayerMinWidth():this.getMinWidth()}}class y extends p{}class f extends p{}class b{constructor(t,e){this.widthCalculator=t,this.triggersResolver=e,this.widthCalculator=t,this.triggersResolver=e}subscribe(t,e){const i=this.widthCalculator.bind(this);this.triggersResolver(t).forEach((function(n){n.subscribe((function(){t.isWidthCalculationLocked||s((function(){e(i(t))}))}),!0)})),s((function(){e(i(t),!0)}))}}const x={fullWidthItem:new b((function(t){return t.getWidth()}),D),fullWidthSystemItem:new b((function(t){return t.getWidth()}),(function(t){return[]})),titleItem:new b((function(t){return t.getWidth()}),(function(t){var e,i;return[null===(e=t.toolbar.title)||void 0===e?void 0:e.hasTitle,null===(i=t.toolbar.title)||void 0===i?void 0:i.text]})),noTextItem:new b((function(t){return t.getNoTextWidth()}),D),contextItem:function(t){return new b((function(e){return t.items.filter((function(t){return"item"===t.getName()&&t.index<e.index&&t.isVisible()})).length>=e.toolbar.minRootItems||!e.isVisible()?0:null}),D)},hiddenItem:new b((function(){return 0}),(function(){return[]}))};class v{constructor(t,e,i,s){this.stateName=t,this.blockUpdaterGetter=e,this.prevLayer=i,this.canApply=s,this.nextLayer=null,this.layoutBlocks=[],this.nextLayer=null,i&&(i.nextLayer=this)}getNextLayer(){return null!=this.nextLayer?this.nextLayer.canApply()?this.nextLayer:this.nextLayer.getNextLayer():null}getPrevLayer(){return null!=this.prevLayer?this.prevLayer.canApply()?this.prevLayer:this.prevLayer.getPrevLayer():null}requestUpdateLayoutModel(){var t;null===(t=this.getPrevLayer())||void 0===t||t.requestUpdateLayoutModel()}isValidWidth(t){if(!this.canApply()||!t)return!1;const e=this.getRange();return!this.getNextLayer()&&e.min>t||!this.getPrevLayer()&&e.max<t||e.min<=t&&e.max>=t}getRange(){return this.latestRange=this.getActualBlocks().reduce(((t,e)=>({min:t.min+e.getMinWidth(),max:t.max+e.getMaxWidth(this)})),{min:0,max:0})}getActualBlocks(){const t=this.getPrevLayer();return t?t.getActualBlocks().map((t=>this.layoutBlocks.filter((function(e){return e.block===t.block}))[0]||t)):this.layoutBlocks}activate(t){t&&this.layoutBlocks.forEach((t=>{t.block.updateState(this.stateName)}))}addBlock(t){const e=this.blockUpdaterGetter(t);e&&this.layoutBlocks.push(this.createBlock(t,e))}removeBlock(t){}}class C extends v{constructor(t,e,i,s){super(t,e,null,s),this.layoutModel=i}requestUpdateLayoutModel(){this.layoutModel.updateLayout()}createBlock(t,e){return new f(this,t,e)}}class I extends v{activate(t){const e=this.getActualBlocks();let i=this.latestRange.max,s=this.stateName;for(let n=e.length-1;n>=0;n--){const r=e[n];if(i>t){if(i-=r.getMaxWidth(this)-r.getMinWidth(),i<=t){r.block.updateState(s);const t=this.getPrevLayer();s=t?t.stateName:"";continue}}r.block.updateState(s)}}getRange(){return this.latestRange=this.getActualBlocks().reduce(((t,e)=>({min:t.min+e.getMinWidth(),max:t.max+e.getMaxWidth(this)})),{min:0,max:0})}createBlock(t,e){return new g(this,t,e)}}class L extends v{createBlock(t,e){return new y(this,t,e)}getRange(){return this.latestRange={min:this.getActualBlocks().reduce((function(t,e){return t+e.getMinWidth()}),0),max:this.getPrevLayerRangeMax()}}getPrevLayerRangeMax(){const t=this.getPrevLayer();return t?t.getRange().max-1:0}}class k{constructor(t){this.onLayerApplied=t,this.layers=[],this.currentWidth=null,this.currentHeight=null}initialize(t,e,i){this.elementContentWidthSubscription=o(e,(e=>{this.currentWidth===e.width&&this.currentHeight===e.height||(null===this.currentWidth&&t.subscribe((t=>{t.addedItems.forEach(this.addBlock.bind(this)),t.removedItems.forEach(this.removeBlock.bind(this))})),this.currentWidth=e.width,this.currentHeight=e.height,i&&i(e))}))}dispose(){this.elementContentWidthSubscription&&a(this.elementContentWidthSubscription)}getLastLayer(){return this.layers[this.layers.length-1]||null}defaultLayer(t,e){this.layers.push(new C("default",t,this,e))}simultaneousTransitionLayer(t,e,i){this.layers.push(new L(t,e,this.getLastLayer(),i))}sequentialTransitionLayer(t,e,i){this.layers.push(new I(t,e,this.getLastLayer(),i))}addBlock(t){this.layers.forEach((function(e){e.addBlock(t)}))}removeBlock(t){this.layers.forEach((function(e){e.removeBlock(t)}))}updateLayout(){const t=this.findLayersForWidth(this.currentWidth);t.length>0&&this.applyLayer(t[0])}resetToDefault(){this.applyLayer(this.layers[0])}applyLayer(t){t.activate(this.currentWidth),this.onLayerApplied&&this.onLayerApplied(t)}findLayersForWidth(t){return this.layers.filter((function(e){return e.isValidWidth(t)}))}forceUpdate(){null!==this.currentWidth&&this.updateLayout()}}class w{constructor(t){this.toolbar=t,this.state="",this._isWidthCalculationLocked=!1,this.index=-1}getWidth(){return this.isVisible()?U(this.getElement()):0}isVisible(){return!0}get isWidthCalculationLocked(){return this._isWidthCalculationLocked}updateState(t){this.state=t,this.updateStateCore(t)}updateStateCore(t){}lockWidthCalculation(){this._isWidthCalculationLocked=!0}unlockWidthCalculation(){this._isWidthCalculationLocked=!1}}class M extends w{constructor(t,e){super(t),this.toolbar=t,this.item=e}getElement(){return this.item.getElement()}updateStateCore(t){this.item.isDisplayed.update(t.indexOf("has-"+this.getName())>-1)}updateVisible(t){t||this.lockWidthCalculation(),this.item.updateVisible(t),t&&this.unlockWidthCalculation()}}class W extends M{constructor(t,e){super(t,e),this.toolbar=t}getNoTextWidth(){return this.item.isDisplayed.value?function(e){let i=U(e);if(e){const s=e.querySelector(".image");if(s){i-=z(s);let e=s;for(;e=e.nextElementSibling;)O(e)||"absolute"===t.getCurrentStyle(e).position||(i-=U(e))}}return i}(this.getElement()):0}getName(){return"item"}isVisible(){return this.item.isDisplayed.value}updateStateCore(t){const e=this.item.toolbar;this.updateVisible(e.minRootItems>0?-1===t.indexOf("has-ellipsis")||this.index<e.minRootItems:-1===t.indexOf("has-ellipsis")&&-1===t.indexOf("has-sidemenu"))}}class R extends M{constructor(t,e){super(t,e),this.toolbar=t}getName(){return"ellipsis"}updateStateCore(t){super.updateStateCore(t),this.updateVisible(this.item.isDisplayed.value)}}class S extends W{constructor(t,e){super(t,e),this.toolbar=t,this.item=e,this.itemBlocks=[],this.addItem(e)}addItem(t){this.itemBlocks.push(new W(this.toolbar,t))}isVisible(){return this.itemBlocks.reduce((function(t,e){return t&&e.isVisible()}),!0)}getWidth(){return this.itemBlocks.reduce((function(t,e){return t+e.getWidth()}),0)}getNoTextWidth(){return this.itemBlocks.reduce((function(t,e){return t+e.getNoTextWidth()}),0)}updateVisible(t){this.itemBlocks.forEach((function(e){e.updateVisible(t)}))}tryAddItem(t){const e=this.itemBlocks[this.itemBlocks.length-1].item;let i=!1;return(i=e.groupName===t.groupName&&e.group===t.group&&e.adaptivePriority.value===t.adaptivePriority.value)&&this.addItem(t),i}}class E extends w{constructor(t,e){super(t),this.toolbar=t,this.item=e}getName(){return"title"}getWidth(){return U(this.getElement(),!0)}getElement(){return this.item.getElement()}}class B{constructor(t,e){this.element=t,this.toolbar=e,this.index=new u(-1),this.isVisible=new u(this.defaultIsVisible()),this.isVisible.subscribe((t=>{this.onIsVisibleChanged(t)}),!0)}defaultIsVisible(){return!0}getElement(){return this.element}updateVisible(t){this.isVisible.update(t)}onIsVisibleChanged(t){const e=this.getElement();e&&(t?this.show(e):this.hide(e))}show(t){t.classList.remove("ta-hidden-item")}hide(t){t.classList.add("ta-hidden-item")}}class V extends B{constructor(){super(...arguments),this.isDisplayed=new u(!0),this.text=new u(""),this.iconCssClass=new u("")}show(t){t.style.display=""}hide(t){t.style.display="none"}}class N extends V{constructor(t,e,i){super(t,e),this.element=t,this.group=i,this.groupName=new u(""),this.adaptivePriority=new u(-1)}onIsVisibleChanged(t){super.onIsVisibleChanged(t),this.group.onItemVisibleChanged()}getElement(){return document.querySelector(j("data-dxtoolbar-item-id",this.id))}getParent(){const t=this.getElement();return t&&t.parentElement?t.parentElement:null}}class T extends V{constructor(t,e){super(t,e),this.element=t}defaultIsVisible(){return null}}class P extends B{constructor(t,e){super(t,e),this.items=[]}addItem(t){this.items.push(t)}onItemVisibleChanged(){if(0===this.items.length)return;const t=this.items.some((t=>t.isVisible.value));this.updateVisible(t)}getElement(){if(0===this.items.length)return null;const t=i(this.items[0].getElement(),j("data-dxtoolbar-group-id",this.toolbar.id));return t||this.items[0].getParent()}}class A extends B{constructor(t,e){super(null,t),this.elementSelector=e,this.hasTitle=new u(!1),this.text=new u(""),this.text.subscribe((t=>{this.hasTitle.update(null!=t&&""!==t)}))}getElement(){return document.querySelector(this.elementSelector)}}class q{constructor(t,e){this.element=t,this.id=e,this.items=[],this.itemMap=new Map,this.groupMap=new Map,this.canHideRootItems=!1,this.canCollapseToIcons=!1,this.minRootItems=0}}class H{constructor(){this.isLoading=!0,this.isLayoutCalculated=!1,this.toolbar=null,this.layoutModel=null,this.reinitRequested=!1}init(e,r,o){this.isLayoutCalculated=!1;const a=o,l=e.dataset.dxtoolbarId,h=j("data-dxtoolbar-title-id",l),u=j("data-dxtoolbar-ellipses-id",l),d=document.querySelector(u),p=this.toolbar=new q(e,l),g=p.groupMap;Array.from(r.items).forEach((t=>{const e=document.querySelector(j("data-dxtoolbar-item-id",t.id)),s=i(e,j("data-dxtoolbar-group-id",l));let n=null;g.has(s)&&(n=g.get(s)),n||(n=new P(s,p),g.set(s,n));const r=new N(e,p,n);r.text.update(t.text),r.groupName.update(t.groupName),r.adaptivePriority.update(t.adaptivePriority),r.iconCssClass.update(t.iconCssClass),r.isDisplayed.update(t.visible),r.index.update(t.index),r.id=t.id,p.itemMap.set(r.id,r),p.items.some((t=>t.index.value===r.index.value))||(n.addItem(r),p.items.push(r))})),p.canHideRootItems=r.canHideRootItems,p.canCollapseToIcons=r.canCollapseToIcons,p.minRootItems=r.minRootItems,p.itemSize=r.itemSize,p.renderMode=r.renderMode;const y=new m([]),f=new A(p,h);f.text.update(r.title),p.title=f,y.add(new E(p,f));const b=Array.from(g.values()),v=b.some((t=>t))?b.map((t=>t.items)).reduce(((t,e)=>t.concat(e))):[];y.addRange(this.getItemsBlocks(p,v));const C=new T(d,p);C.id=r.adaptiveMenuModel.id,y.add(new R(p,C)),p.ellipsesViewModel=C;const I=x.contextItem(y),L=this.layoutModel=new k((i=>{if(!this.isLayoutCalculated){this.isLayoutCalculated=!0;const t=p.element;s((()=>{const e=t.querySelector(".btn-toolbar");this.updateControlStyles(p,Math.ceil(!this.isLoading&&e?e.offsetHeight:t.offsetHeight)),this.isLoading=!1}))}const r=p.element.querySelector(".btn-toolbar")||p.element;if(i.stateName.indexOf("no-item-text")>-1?t.addClassName(r,"no-item-text"):t.removeClassName(r,"no-item-text"),t.removeClassName(e,"dxbs-loading"),n(e))return;const o=p.items.concat(p.ellipsesViewModel).map((t=>({Id:t.id,IsVisible:t.isVisible.value})));a.invokeMethodAsync("OnModelUpdated",Array.from(o)).catch((function(t){n(e)||c.error(t)}))}));L.defaultLayer((function(t){switch(t.getName()){case"item":return x.fullWidthItem;case"title":return x.titleItem}return x.hiddenItem}),(()=>!0)),L.sequentialTransitionLayer("has-ellipsis",(function(t){switch(t.getName()){case"ellipsis":return x.fullWidthSystemItem;case"item":return I}}),(()=>p.canHideRootItems&&p.minRootItems>0)),L.simultaneousTransitionLayer("no-item-text",(function(t){switch(t.getName()){case"item":return x.noTextItem;case"ellipsis":return x.hiddenItem}}),(()=>p.canCollapseToIcons)),L.sequentialTransitionLayer(p.canCollapseToIcons?"no-item-text has-ellipsis":"has-ellipsis",(function(t){switch(t.getName()){case"item":return I;case"ellipsis":return x.fullWidthSystemItem}}),(()=>p.canHideRootItems)),L.initialize(y,p.element.querySelector(".btn-toolbar")||p.element,(t=>{var e;this.height!==t.height&&(this.isLayoutCalculated=!1,this.height=t.height),null===(e=this.layoutModel)||void 0===e||e.updateLayout()})),this.layoutModel=L}reinit(t,e){this.reinitRequested||(this.reinitRequested=!0,r((()=>{this.resetToDefault(),this.disposeModel(),r((()=>{this.reinitRequested=!1,this.init(t.mainElement,t,e)}))})))}resetToDefault(){var t;null===(t=this.layoutModel)||void 0===t||t.resetToDefault()}update(t,e){var i,s;if(!this.toolbar)return;let n=!1,r=!1;this.toolbar.canHideRootItems!==t.canHideRootItems&&(this.toolbar.canHideRootItems=t.canHideRootItems,n=!0),this.toolbar.canCollapseToIcons!==t.canCollapseToIcons&&(this.toolbar.canCollapseToIcons=t.canCollapseToIcons,n=!0),this.toolbar.minRootItems!==t.minRootItems&&(this.toolbar.minRootItems=t.minRootItems,n=!0),this.toolbar.itemSize!==t.itemSize&&(this.toolbar.itemSize=t.itemSize,r=!0),this.toolbar.renderMode!==t.renderMode&&(this.toolbar.renderMode=t.renderMode,r=!0),null===(i=this.toolbar.title)||void 0===i||i.text.update(t.title);const o=Array.from(t.items).map((t=>t.id)),a=Array.from(this.toolbar.itemMap.values()).map((t=>t.id));var l,h;r=r||!((l=o).length===(h=a).length&&l.every(((t,e)=>t===h[e]))),r?this.reinit(t,e):(Array.from(t.items).forEach((t=>{if(!this.toolbar)return;const e=this.toolbar.itemMap.get(t.id);e&&(e.text.update(t.text),e.groupName.update(t.groupName),e.adaptivePriority.update(t.adaptivePriority),e.index.update(t.index),e.iconCssClass.update(t.iconCssClass),e.isDisplayed.update(t.visible))})),n&&(null===(s=this.layoutModel)||void 0===s||s.forceUpdate()))}disposeModel(){var t;null===(t=this.layoutModel)||void 0===t||t.dispose()}dispose(){this.disposeModel()}getItemsBlocks(t,e){return e.reduce(((e,i)=>e.group&&e.group.tryAddItem(i)?e:i.GroupName?{group:e.blocks[e.blocks.length]=new S(t,i),blocks:e.blocks}:{group:null,blocks:e.blocks.concat([new W(t,i)])}),{blocks:[],group:null}).blocks.sort((function(t,e){return t.item.adaptivePriority.value-e.item.adaptivePriority.value})).map((function(t,e){return t.index=e,t}))}updateControlStyles(t,e){t.element.style.height=e+"px"}}function D(t){return[t.item.text,t.item.isDisplayed,t.item.iconCssClass]}function U(e,i=!1){let s=e?Math.ceil(e.offsetWidth+(i?0:z(e))):0;if(e&&e.parentElement){if(e.parentElement.lastElementChild===e){const i=t.getCurrentStyle(e.parentElement);s+=t.pxToInt(i.marginRight)}if(e.parentElement.firstElementChild===e){const i=t.getCurrentStyle(e.parentElement);s+=t.pxToInt(i.marginLeft)}}return s}function z(t){return l(t)}function O(e){return t.hasClassName(e,"popout")}function j(t,e){return`[${t}=${e}]`}const G=new Map;function _(t,i,s){if(!(t=e(t)))return Promise.reject("failed");h(t);let n=G.get(t);n?n.update(i,s):(n=new H,n.init(t,i,s),G.set(t,n));const r=t.querySelector(".btn-toolbar")||t;return d(r),Promise.resolve("ok")}function F(t){if(t=e(t)){h(t);const e=t.querySelector(".btn-toolbar");e&&h(e);const i=G.get(t);i&&(i.dispose(),G.delete(t))}return Promise.resolve("ok")}const $={init:_,dispose:F};export default $;export{F as dispose,_ as init};
